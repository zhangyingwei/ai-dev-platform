/**
 * Simple Markdown Editor
 * ËΩªÈáèÁ∫ßMarkdownÁºñËæëÂô®
 */
class SimpleMarkdownEditor {
    constructor(element, options = {}) {
        this.element = element;
        this.options = {
            placeholder: 'ËØ∑ËæìÂÖ•ÂÜÖÂÆπ...',
            toolbar: true,
            preview: true,
            autosave: false,
            ...options
        };
        
        this.isPreviewMode = false;
        this.isSideBySide = false;
        
        this.init();
    }
    
    init() {
        this.createEditor();
        this.bindEvents();
        
        if (this.options.autosave) {
            this.setupAutosave();
        }
    }
    
    createEditor() {
        // ÂàõÂª∫ÁºñËæëÂô®ÂÆπÂô®
        this.container = document.createElement('div');
        this.container.className = 'markdown-editor-container';
        
        // ÂàõÂª∫Â∑•ÂÖ∑Ê†è
        if (this.options.toolbar) {
            this.createToolbar();
        }
        
        // ÂàõÂª∫ÁºñËæëÂô®‰∏ª‰Ωì
        this.createEditorBody();
        
        // ÂàõÂª∫Áä∂ÊÄÅÊ†è
        this.createStatusBar();
        
        // ÊõøÊç¢ÂéüÂßãÂÖÉÁ¥†
        this.element.parentNode.replaceChild(this.container, this.element);
    }
    
    createToolbar() {
        this.toolbar = document.createElement('div');
        this.toolbar.className = 'markdown-toolbar';
        
        const buttons = [
            { name: 'wysiwyg', icon: 'üìù', title: 'ÊâÄËßÅÂç≥ÊâÄÂæó', action: () => this.toggleWysiwyg() },
            { name: 'separator' },
            { name: 'bold', icon: 'B', title: 'Á≤ó‰Ωì', action: () => this.insertText('**', '**') },
            { name: 'italic', icon: 'I', title: 'Êñú‰Ωì', action: () => this.insertText('*', '*') },
            { name: 'heading', icon: 'H', title: 'Ê†áÈ¢ò', action: () => this.insertText('## ', '') },
            { name: 'separator' },
            { name: 'quote', icon: '"', title: 'ÂºïÁî®', action: () => this.insertText('> ', '') },
            { name: 'list', icon: '‚Ä¢', title: 'ÂàóË°®', action: () => this.insertText('- ', '') },
            { name: 'ordered-list', icon: '1.', title: 'ÊúâÂ∫èÂàóË°®', action: () => this.insertText('1. ', '') },
            { name: 'separator' },
            { name: 'link', icon: 'üîó', title: 'ÈìæÊé•', action: () => this.insertText('[', '](url)') },
            { name: 'image', icon: 'üñºÔ∏è', title: 'ÂõæÁâá', action: () => this.insertText('![', '](url)') },
            { name: 'code', icon: '<>', title: '‰ª£Á†Å', action: () => this.insertText('`', '`') },
            { name: 'separator' },
            { name: 'preview', icon: 'üëÅÔ∏è', title: 'È¢ÑËßà', action: () => this.togglePreview() },
            { name: 'side-by-side', icon: '‚öå', title: 'ÂàÜÂ±è', action: () => this.toggleSideBySide() },
        ];
        
        buttons.forEach(button => {
            if (button.name === 'separator') {
                const separator = document.createElement('div');
                separator.className = 'separator';
                this.toolbar.appendChild(separator);
            } else {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.innerHTML = button.icon;
                btn.title = button.title;
                btn.onclick = button.action;
                this.toolbar.appendChild(btn);
            }
        });
        
        this.container.appendChild(this.toolbar);
    }
    
    createEditorBody() {
        this.editorWrapper = document.createElement('div');
        this.editorWrapper.className = 'markdown-editor-wrapper';

        // ÂàõÂª∫ÊñáÊú¨ËæìÂÖ•Âå∫Âüü
        this.textarea = document.createElement('textarea');
        this.textarea.className = 'markdown-editor-input';
        this.textarea.placeholder = this.options.placeholder;
        this.textarea.value = this.element.value || '';

        // ÂàõÂª∫È¢ÑËßàÂå∫Âüü
        this.preview = document.createElement('div');
        this.preview.className = 'markdown-editor-preview hidden';

        // ÂàõÂª∫WYSIWYGÁºñËæëÂå∫Âüü
        this.wysiwygEditor = document.createElement('div');
        this.wysiwygEditor.className = 'markdown-wysiwyg-editor hidden';
        this.wysiwygEditor.contentEditable = true;
        this.wysiwygEditor.innerHTML = '<p>ÂºÄÂßãËæìÂÖ•...</p>';

        this.editorWrapper.appendChild(this.textarea);
        this.editorWrapper.appendChild(this.wysiwygEditor);
        this.editorWrapper.appendChild(this.preview);
        this.container.appendChild(this.editorWrapper);
    }
    
    createStatusBar() {
        this.statusBar = document.createElement('div');
        this.statusBar.className = 'markdown-status-bar';
        
        this.statusLeft = document.createElement('span');
        this.statusRight = document.createElement('span');
        
        this.statusBar.appendChild(this.statusLeft);
        this.statusBar.appendChild(this.statusRight);
        this.container.appendChild(this.statusBar);
        
        this.updateStatus();
    }
    
    bindEvents() {
        this.textarea.addEventListener('input', () => {
            this.updatePreview();
            this.updateStatus();

            if (this.options.onChange) {
                this.options.onChange(this.value());
            }
        });

        this.textarea.addEventListener('keydown', (e) => {
            // TabÈîÆÊèíÂÖ•Á©∫Ê†º
            if (e.key === 'Tab') {
                e.preventDefault();
                this.insertText('    ', '');
            }
        });

        // WYSIWYGÁºñËæëÂô®‰∫ã‰ª∂
        this.wysiwygEditor.addEventListener('input', () => {
            this.syncWysiwygToMarkdown();
            this.updateStatus();

            if (this.options.onChange) {
                this.options.onChange(this.value());
            }
        });

        this.wysiwygEditor.addEventListener('keyup', () => {
            this.syncWysiwygToMarkdown();
            this.updateStatus();
        });

        this.wysiwygEditor.addEventListener('paste', () => {
            setTimeout(() => {
                this.syncWysiwygToMarkdown();
                this.updateStatus();
            }, 10);
        });

        this.wysiwygEditor.addEventListener('keydown', (e) => {
            // Â§ÑÁêÜÂø´Êç∑ÈîÆ
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'b':
                        e.preventDefault();
                        this.execCommand('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        this.execCommand('italic');
                        break;
                }
            }

            // Â§ÑÁêÜÂõûËΩ¶ÈîÆ
            if (e.key === 'Enter') {
                setTimeout(() => {
                    this.syncWysiwygToMarkdown();
                    this.updateStatus();
                }, 10);
            }
        });
    }
    
    setupAutosave() {
        if (this.options.autosave.enabled) {
            setInterval(() => {
                const content = this.value();
                if (content !== this.lastSavedContent) {
                    localStorage.setItem(this.options.autosave.uniqueId, content);
                    this.lastSavedContent = content;
                    this.statusLeft.textContent = 'Â∑≤Ëá™Âä®‰øùÂ≠ò';
                    setTimeout(() => {
                        this.updateStatus();
                    }, 2000);
                }
            }, this.options.autosave.delay || 5000);
            
            // Âä†ËΩΩ‰øùÂ≠òÁöÑÂÜÖÂÆπ
            const saved = localStorage.getItem(this.options.autosave.uniqueId);
            if (saved && !this.textarea.value) {
                this.textarea.value = saved;
                this.updatePreview();
            }
        }
    }
    
    insertText(before, after) {
        const start = this.textarea.selectionStart;
        const end = this.textarea.selectionEnd;
        const selectedText = this.textarea.value.substring(start, end);
        const newText = before + selectedText + after;
        
        this.textarea.setRangeText(newText, start, end, 'end');
        this.textarea.focus();
        
        this.updatePreview();
        this.updateStatus();
    }
    
    togglePreview() {
        this.isPreviewMode = !this.isPreviewMode;
        this.isSideBySide = false;
        
        if (this.isPreviewMode) {
            this.textarea.style.display = 'none';
            this.preview.classList.remove('hidden');
            this.preview.style.borderLeft = 'none';
        } else {
            this.textarea.style.display = 'block';
            this.preview.classList.add('hidden');
        }
        
        this.updatePreview();
    }
    
    toggleSideBySide() {
        this.isSideBySide = !this.isSideBySide;
        this.isPreviewMode = false;
        this.isWysiwygMode = false;

        if (this.isSideBySide) {
            this.textarea.style.display = 'block';
            this.wysiwygEditor.classList.add('hidden');
            this.preview.classList.remove('hidden');
            this.preview.style.borderLeft = '1px solid #e5e7eb';
        } else {
            this.preview.classList.add('hidden');
        }

        this.updatePreview();
    }

    toggleWysiwyg() {
        this.isWysiwygMode = !this.isWysiwygMode;
        this.isPreviewMode = false;
        this.isSideBySide = false;

        if (this.isWysiwygMode) {
            this.textarea.style.display = 'none';
            this.preview.classList.add('hidden');
            this.wysiwygEditor.classList.remove('hidden');
            this.syncMarkdownToWysiwyg();
        } else {
            this.textarea.style.display = 'block';
            this.wysiwygEditor.classList.add('hidden');
            this.syncWysiwygToMarkdown();
        }
    }

    syncMarkdownToWysiwyg() {
        const markdownContent = this.textarea.value;
        const htmlContent = this.markdownToHtml(markdownContent);
        this.wysiwygEditor.innerHTML = htmlContent || '<p>ÂºÄÂßãËæìÂÖ•...</p>';
    }

    syncWysiwygToMarkdown() {
        if (!this.isWysiwygMode) return;

        const htmlContent = this.wysiwygEditor.innerHTML;
        const markdownContent = this.htmlToMarkdown(htmlContent);
        this.textarea.value = markdownContent;

        // Ëß¶ÂèëtextareaÁöÑinput‰∫ã‰ª∂‰ª•Á°Æ‰øùÂÖ∂‰ªñÁõëÂê¨Âô®ËÉΩÊî∂Âà∞Êõ¥Êñ∞
        const event = new Event('input', { bubbles: true });
        this.textarea.dispatchEvent(event);
    }

    execCommand(command) {
        document.execCommand(command, false, null);
        this.syncWysiwygToMarkdown();
    }

    htmlToMarkdown(html) {
        // ÂàõÂª∫‰∏¥Êó∂DOMÂÖÉÁ¥†Êù•Ëß£ÊûêHTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;

        // ÈÄíÂΩíÂ§ÑÁêÜDOMËäÇÁÇπ
        const processNode = (node) => {
            if (node.nodeType === Node.TEXT_NODE) {
                return node.textContent;
            }

            if (node.nodeType === Node.ELEMENT_NODE) {
                const tagName = node.tagName.toLowerCase();
                const children = Array.from(node.childNodes).map(processNode).join('');

                switch (tagName) {
                    case 'h1':
                        return `# ${children}\n\n`;
                    case 'h2':
                        return `## ${children}\n\n`;
                    case 'h3':
                        return `### ${children}\n\n`;
                    case 'h4':
                        return `#### ${children}\n\n`;
                    case 'h5':
                        return `##### ${children}\n\n`;
                    case 'h6':
                        return `###### ${children}\n\n`;
                    case 'strong':
                    case 'b':
                        return `**${children}**`;
                    case 'em':
                    case 'i':
                        return `*${children}*`;
                    case 'code':
                        return `\`${children}\``;
                    case 'a':
                        const href = node.getAttribute('href') || '';
                        return `[${children}](${href})`;
                    case 'img':
                        const src = node.getAttribute('src') || '';
                        const alt = node.getAttribute('alt') || '';
                        return `![${alt}](${src})`;
                    case 'blockquote':
                        return `> ${children}\n\n`;
                    case 'ul':
                        return `${children}\n`;
                    case 'ol':
                        return `${children}\n`;
                    case 'li':
                        return `- ${children}\n`;
                    case 'p':
                        return `${children}\n\n`;
                    case 'br':
                        return '\n';
                    case 'div':
                        return `${children}\n`;
                    default:
                        return children;
                }
            }

            return '';
        };

        const markdown = processNode(tempDiv)
            // Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑÊç¢Ë°å
            .replace(/\n{3,}/g, '\n\n')
            .trim();

        return markdown;
    }
    
    updatePreview() {
        if (!this.preview.classList.contains('hidden')) {
            this.preview.innerHTML = this.markdownToHtml(this.textarea.value);
        }
    }
    
    updateStatus() {
        const content = this.textarea.value;
        const lines = content.split('\n').length;
        const words = content.trim() ? content.trim().split(/\s+/).length : 0;
        const chars = content.length;
        
        this.statusRight.textContent = `${lines} Ë°å, ${words} ËØç, ${chars} Â≠óÁ¨¶`;
    }
    
    markdownToHtml(markdown) {
        // ÁÆÄÂçïÁöÑMarkdownËΩ¨HTMLÂÆûÁé∞
        let html = markdown
            // Ê†áÈ¢ò
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            // Á≤ó‰ΩìÂíåÊñú‰Ωì
            .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
            .replace(/\*(.*)\*/gim, '<em>$1</em>')
            // ‰ª£Á†Å
            .replace(/`(.*?)`/gim, '<code>$1</code>')
            // ÈìæÊé•
            .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2">$1</a>')
            // ÂõæÁâá
            .replace(/!\[([^\]]*)\]\(([^)]+)\)/gim, '<img src="$2" alt="$1">')
            // ÂºïÁî®
            .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
            // ÂàóË°®
            .replace(/^\- (.*$)/gim, '<li>$1</li>')
            .replace(/^(\d+)\. (.*$)/gim, '<li>$1. $2</li>')
            // Êç¢Ë°å
            .replace(/\n/gim, '<br>');
            
        // ÂåÖË£ÖÂàóË°®È°π
        html = html.replace(/(<li>.*<\/li>)/gims, '<ul>$1</ul>');
        
        return html;
    }
    
    value(val) {
        if (val !== undefined) {
            this.textarea.value = val;
            this.updatePreview();
            this.updateStatus();
            return this;
        }
        return this.textarea.value;
    }
    
    focus() {
        this.textarea.focus();
        return this;
    }
    
    destroy() {
        if (this.container && this.container.parentNode) {
            this.container.parentNode.replaceChild(this.element, this.container);
        }
    }
}

// ÂÖ®Â±ÄÊö¥Èú≤
window.SimpleMarkdownEditor = SimpleMarkdownEditor;
